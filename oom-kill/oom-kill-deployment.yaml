apiVersion: apps/v1
kind: Deployment
metadata:
  name: oom-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oom-demo
  template:
    metadata:
      labels:
        app: oom-demo
    spec:
      containers:
      - name: oom-demo-container
        image: ubuntu:latest
        command: ["/bin/bash", "-c"]
        args:
          - |
            set -e
            echo "Starting memory allocation..."
            mkdir -p /dev/shm/mem
            i=0
            while true; do
              fallocate -l 10M /dev/shm/mem/file$i
              ALLOCATED=$(( (i+1) * 10 ))
              echo "Allocated 10M, total allocated: ${ALLOCATED}M"
              i=$((i+1))
              sleep 1
            done
---
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: vpa-demo-oom
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind:       Deployment
    name:       oom-demo
  updatePolicy:
    updateMode: "Recreate"  # Use explicit mode instead of deprecated "Auto"